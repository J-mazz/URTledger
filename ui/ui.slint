import { Button, VerticalBox, LineEdit, ScrollView, HorizontalBox, ComboBox, ListView } from "std-widgets.slint";

export struct ConfigItem {
    id: int,
    name: string,
    display_text: string, 
}

export struct SpecField {
    name: string,
    value: string, 
}

export component MainWindow inherits Window {
    title: "URT Ledger - Inventory Management";
    min-width: 900px;
    min-height: 700px;

    in-out property <int> current_view: 0;
    in-out property <int> settings_category_index: 0;

    in property <float> stage_total_weight: 0.0;
    in property <int> stage_batch_count: 0;
    
    in property <[ConfigItem]> stages_list: [];
    in property <[ConfigItem]> grades_list: [];
    in property <[ConfigItem]> types_list: []; 
    
    in property <[string]> stage_names: [];
    in property <[string]> grade_names: [];
    in property <[string]> type_names: [];
    
    in-out property <[SpecField]> active_specs: [];

    callback add_batch(int, string, string, string, int, int, [SpecField]);
    callback request_stage_summary(int);
    callback type_selected(int);
    
    callback add_new_stage(string);
    callback add_new_grade(string);
    callback add_new_type(string, string);

    VerticalBox {
        padding: 0px; 
        
        // --- HEADER ---
        Rectangle {
            height: 60px;
            background: #2c2c2c;
            HorizontalBox {
                alignment: space-between;
                padding: 10px;
                Text { 
                    text: root.current_view == 0 ? "Inventory Entry" : "Settings & Configuration"; 
                    color: white; 
                    font-size: 20px; 
                    vertical-alignment: center;
                }
                
                Button {
                    text: root.current_view == 0 ? "⚙ Settings" : "← Back";
                    width: 100px;
                    clicked => {
                        if (root.current_view == 0) {
                            root.current_view = 1;
                        } else {
                            root.current_view = 0;
                        }
                    }
                }
            }
        }

        // --- VIEW 0: ENTRY ---
        if (root.current_view == 0) : VerticalBox {
            padding: 20px;
            spacing: 15px;

            Text { text: "Select Parameters"; font-size: 14px; font-weight: 700; }
            
            HorizontalBox {
                spacing: 10px;
                VerticalBox {
                    Text { text: "Product Type:"; font-size: 12px; }
                    type_combo := ComboBox {
                        model: root.type_names;
                        height: 35px;
                        selected => { root.type_selected(self.current-index); }
                    }
                }
                VerticalBox {
                    Text { text: "Processing Stage:"; font-size: 12px; }
                    stage_combo := ComboBox {
                        model: root.stage_names;
                        height: 35px;
                    }
                }
                VerticalBox {
                    Text { text: "Quality Grade:"; font-size: 12px; }
                    grade_combo := ComboBox {
                        model: root.grade_names;
                        height: 35px;
                    }
                }
            }

            if (root.active_specs.length > 0) : VerticalBox {
                spacing: 5px;
                Text { text: "Specifications:"; font-weight: 700; font-size: 12px; }
                for spec[i] in root.active_specs : HorizontalBox {
                    Text { 
                        text: spec.name + ":"; 
                        vertical-alignment: center; 
                        width: 100px;
                    }
                    LineEdit {
                        placeholder-text: "Enter value...";
                        text: spec.value;
                        edited(text) => {
                            spec.value = text;
                        }
                    }
                }
            }

            Text { text: "Batch Details"; font-size: 14px; font-weight: 700; }
            batch_name_input := LineEdit { placeholder-text: "Batch Identifier"; height: 35px; }
            HorizontalBox {
                weight_input := LineEdit { placeholder-text: "Weight (lbs)"; height: 35px; }
                price_input := LineEdit { placeholder-text: "Price per Unit ($)"; height: 35px; }
            }

            Button {
                text: "Save Batch";
                primary: true;
                height: 45px;
                clicked => {
                    root.add_batch(
                        type_combo.current-index,
                        batch_name_input.text, 
                        weight_input.text, 
                        price_input.text, 
                        root.grades_list.length > 0 ? root.grades_list[grade_combo.current-index].id : 0,
                        root.stages_list.length > 0 ? root.stages_list[stage_combo.current-index].id : 0,
                        root.active_specs 
                    );

                    batch_name_input.text = ""; 
                    weight_input.text = ""; 
                    price_input.text = "";
                    root.type_selected(type_combo.current-index);
                }
            }
            
            Rectangle {
                background: #e0e0e0;
                border-radius: 8px;
                height: 80px;
                VerticalBox {
                    alignment: center;
                    Text { text: "Summary for Selected Stage"; color: #555; font-size: 12px; }
                    Text { text: root.stage_total_weight + " lbs  |  " + root.stage_batch_count + " Batches"; color: #2c2c2c; font-size: 24px; font-weight: 700; }
                }
            }
        }

        // --- VIEW 1: SETTINGS ---
        if (root.current_view == 1) : VerticalBox {
            padding: 20px;
            spacing: 20px;
            
            Text { text: "Edit Application Parameters"; font-size: 18px; horizontal-alignment: center; }

            HorizontalBox {
                alignment: center;
                Text { text: "Edit Section: "; vertical-alignment: center; font-size: 16px; }
                ComboBox {
                    width: 200px;
                    height: 40px;
                    model: ["Processing Stages", "Quality Grades", "Product Types"];
                    current-index: 0;
                    selected => { root.settings_category_index = self.current-index; }
                }
            }

            if (root.settings_category_index == 0) : VerticalBox {
                Text { text: "Manage Stages (Unbucked, Bucked, etc.)"; font-weight: 700; }
                Rectangle { 
                    background: #f0f0f0; 
                    border-radius: 4px;
                    height: 300px;
                    ScrollView { VerticalBox { 
                        // Removed 'padding: 5px' from Text to fix warnings
                        for item in root.stages_list : Text { text: " • " + item.name; font-size: 16px; }
                    }}
                }
                HorizontalBox {
                    s_input := LineEdit { placeholder-text: "New Stage Name"; }
                    Button { text: "Add Stage"; width: 100px; clicked => { root.add_new_stage(s_input.text); s_input.text = ""; } }
                }
            }

            if (root.settings_category_index == 1) : VerticalBox {
                Text { text: "Manage Grades (A, B, C, Trim)"; font-weight: 700; }
                Rectangle { 
                    background: #f0f0f0; 
                    border-radius: 4px;
                    height: 300px;
                    ScrollView { VerticalBox { 
                        for item in root.grades_list : Text { text: " • " + item.name; font-size: 16px; }
                    }}
                }
                HorizontalBox {
                    g_input := LineEdit { placeholder-text: "New Grade Name"; }
                    Button { text: "Add Grade"; width: 100px; clicked => { root.add_new_grade(g_input.text); g_input.text = ""; } }
                }
            }

            if (root.settings_category_index == 2) : VerticalBox {
                Text { text: "Manage Product Types & Attributes"; font-weight: 700; }
                Rectangle { 
                    background: #f0f0f0; 
                    border-radius: 4px;
                    height: 300px;
                    ScrollView { VerticalBox { 
                        for item in root.types_list : Text { text: " • " + item.display_text; font-size: 16px; }
                    }}
                }
                VerticalBox {
                    spacing: 10px;
                    t_name := LineEdit { placeholder-text: "Type Name (e.g. Flower)"; }
                    t_specs := LineEdit { placeholder-text: "Attributes (comma separated: THC, Terps)"; }
                    Button { 
                        text: "Add Product Type"; 
                        clicked => { 
                            root.add_new_type(t_name.text, t_specs.text); 
                            t_name.text = ""; t_specs.text = "";
                        } 
                    }
                }
            }
        }
    }
}